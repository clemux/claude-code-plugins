#!/usr/bin/env bash
set -euo pipefail

input=$(cat)

# Only act on writes to ~/.claude/plans/
file_path=$(printf '%s' "$input" | jq -r '.tool_input.file_path // empty')
plans_dir="${HOME}/.claude/plans"

if [[ "$file_path" != "${plans_dir}/"* ]]; then
  exit 0
fi

session_id=$(printf '%s' "$input" | jq -r '.session_id // empty')

if [[ -z "$session_id" ]]; then
  exit 0
fi

state_dir="${XDG_RUNTIME_DIR:-/tmp}/plan-guard"
model_file="${state_dir}/model-${session_id}"

if [[ ! -f "$model_file" ]]; then
  exit 0
fi

model=$(cat "$model_file")

# Opus plans don't need tagging
if printf '%s' "$model" | grep -qi 'opus'; then
  exit 0
fi

# Prepend warning header in place (don't rename â€” Claude Code tracks the original path)
if [[ -f "$file_path" ]]; then
  warning="> **WARNING:** This plan was generated by \`${model}\` (not Opus). Review carefully before implementing."
  tmp="${file_path}.tmp"
  { printf '%s\n\n' "$warning"; cat "$file_path"; } > "$tmp"
  mv "$tmp" "$file_path"
fi

exit 0
