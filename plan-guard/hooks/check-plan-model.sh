#!/usr/bin/env bash
set -euo pipefail

input=$(cat)

session_id=$(printf '%s' "$input" | jq -r '.session_id // empty')

if [[ -z "$session_id" ]]; then
  exit 0
fi

state_dir="${XDG_RUNTIME_DIR:-/tmp}/plan-guard"
model_file="${state_dir}/model-${session_id}"

if [[ ! -f "$model_file" ]]; then
  exit 0
fi

model=$(cat "$model_file")

if printf '%s' "$model" | grep -qi 'opus'; then
  exit 0
fi

# Tailor message to the tool being called
tool=$(printf '%s' "$input" | jq -r '.tool_name // empty')

if [[ "$tool" == "ExitPlanMode" ]]; then
  msg="This plan was generated by ${model} (not Opus). Review it carefully before approving."
else
  msg="Current model is ${model} (not Opus). Planning works best with Opus â€” consider switching with /model before proceeding."
fi

printf '{"hookSpecificOutput":{"permissionDecision":"ask"},"systemMessage":"%s"}' "$msg" >&2
exit 2
